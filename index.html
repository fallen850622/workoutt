<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>運動監測系統 v3.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --accent: #94a3b8;
            --success: #475569; --item-bg: #f1f5f9; --blue-light: #e2e8f0; --danger: #f87171;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        
        .tab-bar { position: sticky; top: 0; display: flex; background: var(--card); box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 100; }
        .tab-btn { flex: 1; padding: 18px 5px; border: none; background: none; font-weight: bold; color: var(--accent); cursor: pointer; border-bottom: 3px solid transparent; font-size: 0.95rem; }
        .tab-btn.active { color: var(--success); border-bottom-color: var(--success); }
        
        .page { display: none; padding: 15px; flex-direction: column; align-items: center; width: 100%; }
        .page.active { display: flex; }

        .card { background: var(--card); border-radius: 24px; padding: 20px; width: 100%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .chart-card { height: 350px; position: relative; }

        /* 數據欄位 - 鍵盤優化樣式 */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; }
        .input-group { display: flex; flex-direction: column; align-items: center; }
        .input-group label { font-size: 0.75rem; color: var(--accent); margin-bottom: 6px; font-weight: 500; }
        .input-group input { 
            border: 1px solid var(--blue-light); 
            border-radius: 12px; 
            padding: 12px 5px; 
            text-align: center; 
            outline: none; 
            width: 100%; 
            font-size: 1.1rem; 
            background: #fff; 
            /* 移除瀏覽器預設箭頭 */
            appearance: none;
            -moz-appearance: textfield;
        }
        .input-group input::-webkit-outer-spin-button, 
        .input-group input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* 甘特圖 */
        .gantt-container { overflow-x: auto; width: 100%; border-radius: 12px; }
        .gantt-table { border-collapse: collapse; font-size: 0.75rem; min-width: 700px; }
        .gantt-table th, .gantt-table td { border: 1px solid #f1f5f9; padding: 12px 6px; text-align: center; }
        .gantt-row-title { text-align: left; background: #fff; font-weight: bold; position: sticky; left: 0; z-index: 2; min-width: 120px; box-shadow: 2px 0 5px rgba(0,0,0,0.03); }
        .count-badge { background: #f1f5f9; color: #475569; padding: 2px 6px; border-radius: 6px; font-size: 0.65rem; margin-left: 4px; }
        .gantt-cell.active { background: #475569; color: white; font-weight: bold; }

        /* 日曆與列表 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .day { padding: 12px 0; border-radius: 10px; font-size: 0.9rem; cursor: pointer; color: #94a3b8; position: relative; }
        .day.selected { background: #475569; color: white; }
        .day.has-workout::after { content: ''; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: #cbd5e1; border-radius: 50%; }
        
        .item-wrapper { position: relative; margin-bottom: 12px; border-radius: 18px; border: 1px solid #e2e8f0; background: var(--danger); overflow: hidden; width: 100%; max-width: 450px; }
        .training-group { background: var(--card); transition: transform 0.3s ease; position: relative; z-index: 2; }
        .group-header { padding: 18px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; }
        .group-header.active { background: #475569; color: white; }
        .details { padding: 18px; background: #f8fafc; font-size: 0.85rem; display: none; border-top: 1px solid #e2e8f0; }
        .details.show { display: block; }
        .btn-add { width: 100%; max-width: 450px; padding: 16px; background: transparent; border: 2px dashed #cbd5e1; border-radius: 15px; color: #64748b; font-weight: bold; cursor: pointer; margin-bottom: 60px; }
    </style>
</head>
<body>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchPage('daily')">今日紀錄</button>
        <button class="tab-btn" onclick="switchPage('gantt')">運動統計</button>
        <button class="tab-btn" onclick="switchPage('chart')">趨勢圖表</button>
    </div>

    <div id="daily" class="page active">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <button onclick="changeMonth(-1)" style="border:none; background:none; font-size:1.5rem; color:#94a3b8;">‹</button>
                <span id="monthYearDisplay" style="font-weight:bold; font-size:1.1rem;"></span>
                <button onclick="changeMonth(1)" style="border:none; background:none; font-size:1.5rem; color:#94a3b8;">›</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="card">
            <div class="stats-grid">
                <div class="input-group">
                    <label>身高(cm)</label>
                    <input type="text" inputmode="decimal" id="height" placeholder="--" oninput="saveBodyStats()">
                </div>
                <div class="input-group">
                    <label>體重(kg)</label>
                    <input type="text" inputmode="decimal" id="weight" placeholder="--" oninput="saveBodyStats()">
                </div>
                <div class="input-group">
                    <label>體脂(%)</label>
                    <input type="text" inputmode="decimal" id="bodyFat" placeholder="--" oninput="saveBodyStats()">
                </div>
            </div>
        </div>

        <div id="selectedDateText" style="margin: 15px 0; font-weight: bold; color: #475569;">日期：載入中...</div>
        <div id="workoutList" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        <button class="btn-add" onclick="addNewItem()">+ 自定義新增項目</button>
    </div>

    <div id="gantt" class="page">
        <div class="card" style="max-width: 100%; overflow: hidden;">
            <h3 style="text-align: center; margin-top: 0;">本月運動報表</h3>
            <div class="gantt-container" id="ganttBox"></div>
        </div>
    </div>

    <div id="chart" class="page">
        <div class="card chart-card"><canvas id="weightChart"></canvas></div>
        <div class="card chart-card"><canvas id="fatChart"></canvas></div>
    </div>

    <script>
        const workoutData = {
            "腹肌訓練": ["Dead bug / 慢速登山者", "Leg raise combo / 後仰坐姿肩推"],
            "直角肩訓練": ["開合跳肩推 / 伏地挺身+側轉體", "Walking w / 肩環繞"],
            "背肌訓練": ["俯身開背 / 短槓划船", "單手划船 / 彈力繩划船"],
            "臀部訓練": ["Sumo深蹲 / 螃蟹走路 7趟", "深蹲跳 / 後弓箭步"],
            "全身訓練": ["側棒夾腿 / 跪膝伏地挺身", "弓箭步彎舉 / 深蹲肩推"],
            "平板撐系列": ["單手移啞鈴 / 啞鈴抬舉+深蹲跳", "墊腳深蹲 / 弓箭步抬腳"],
            "三頭訓練": ["啞鈴後舉 / 三頭自體屈伸", "深蹲肩前舉 / 波比跳+伏地挺身"],
            "臀部加強++": ["抬膝跑+深蹲 20組", "螃蟹走來回七趟", "Sumo跳+深蹲跳"]
        };

        let currentViewDate = new Date();
        let selectedDateStr = new Date().toLocaleDateString('sv-SE');
        let weightChart, fatChart;

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.currentTarget.classList.add('active');
            if(pageId === 'gantt') renderGantt();
            if(pageId === 'chart') setTimeout(renderCharts, 100);
        }

        function saveBodyStats() {
            const h = document.getElementById('height').value, w = document.getElementById('weight').value, f = document.getElementById('bodyFat').value;
            localStorage.setItem('stats_' + selectedDateStr, JSON.stringify({h, w, f}));
            if(h) localStorage.setItem('global_height', h);
        }

        function loadDailyData(dateStr) {
            selectedDateStr = dateStr;
            document.getElementById('selectedDateText').innerText = `日期：${dateStr}`;
            const activeItems = JSON.parse(localStorage.getItem('workout_' + dateStr) || '[]');
            const saved = JSON.parse(localStorage.getItem('stats_' + dateStr) || '{}');
            document.getElementById('height').value = saved.h || localStorage.getItem('global_height') || "";
            document.getElementById('weight').value = saved.w || "";
            document.getElementById('bodyFat').value = saved.f || "";
            initWorkoutList(activeItems);
        }

        function initWorkoutList(activeItems) {
            const container = document.getElementById('workoutList');
            container.innerHTML = '';
            const customs = JSON.parse(localStorage.getItem('customWorkouts') || '{}');
            const all = {...workoutData, ...customs};

            for (let title in all) {
                const isCustom = customs.hasOwnProperty(title), isActive = activeItems.includes(title);
                const wrapper = document.createElement('div');
                wrapper.className = 'item-wrapper';
                wrapper.innerHTML = `
                    <div style="position:absolute; right:0; top:0; bottom:0; width:80px; background:#f87171; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold;" onclick="deleteItem('${title}')">刪除</div>
                    <div class="training-group" id="item-${title}" ontouchstart="sX=event.touches[0].clientX" ontouchmove="if(event.touches[0].clientX-sX<-50 && ${isCustom}) this.style.transform='translateX(-80px)'; if(event.touches[0].clientX-sX>50) this.style.transform='translateX(0px)';">
                        <div class="group-header ${isActive?'active':''}" onclick="toggleWorkout(this, '${title}')">
                            <span>${title}</span><span>${isActive?'●':'○'}</span>
                        </div>
                        <div class="details ${isActive?'show':''}">
                            ${all[title].map(i => `<div>· ${i}</div>`).join('')}
                        </div>
                    </div>`;
                container.appendChild(wrapper);
            }
        }

        function toggleWorkout(el, title) {
            el.classList.toggle('active');
            el.nextElementSibling.classList.toggle('show');
            const actives = Array.from(document.querySelectorAll('.group-header.active')).map(h => h.querySelector('span:first-child').innerText);
            localStorage.setItem('workout_' + selectedDateStr, JSON.stringify(actives));
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
            document.getElementById('monthYearDisplay').innerText = `${y}年 ${m+1}月`;
            const first = new Date(y, m, 1).getDay(), days = new Date(y, m+1, 0).getDate();
            for (let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
            for (let d=1; d<=days; d++) {
                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const el = document.createElement('div'); el.className = 'day' + (dStr===selectedDateStr?' selected':'');
                if(localStorage.getItem('workout_'+dStr)) el.classList.add('has-workout');
                el.innerText = d; el.onclick = () => { loadDailyData(dStr); renderCalendar(); };
                grid.appendChild(el);
            }
        }

        function changeMonth(s) { currentViewDate.setMonth(currentViewDate.getMonth()+s); renderCalendar(); }

        function renderGantt() {
            const box = document.getElementById('ganttBox');
            const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
            const days = new Date(y, m+1, 0).getDate();
            const customs = JSON.parse(localStorage.getItem('customWorkouts') || '{}');
            const allTitles = [...Object.keys(workoutData), ...Object.keys(customs)];

            let html = `<table class="gantt-table"><tr><th class="gantt-row-title">項目 / 次數</th>`;
            for(let d=1; d<=days; d++) html += `<th style="background:#f8fafc">${d}</th>`;
            html += `</tr>`;

            allTitles.forEach(title => {
                let totalCount = 0;
                let cells = "";
                for(let d=1; d<=days; d++) {
                    const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const done = (JSON.parse(localStorage.getItem('workout_'+dStr)) || []).includes(title);
                    if(done) totalCount++;
                    cells += `<td class="gantt-cell ${done?'active':''}">${done?'✔':''}</td>`;
                }
                html += `<tr><td class="gantt-row-title">${title}<span class="count-badge">${totalCount}次</span></td>${cells}</tr>`;
            });
            box.innerHTML = html + `</table>`;
        }

        function renderCharts() {
            const dates = [], weights = [], fats = [];
            for(let i=6; i>=0; i--) { 
                const d = new Date(); d.setDate(d.getDate()-i);
                const dStr = d.toLocaleDateString('sv-SE');
                const s = JSON.parse(localStorage.getItem('stats_'+dStr) || '{}');
                dates.push(dStr.slice(5));
                weights.push(s.w || null);
                fats.push(s.f || null);
            }

            const chartConfig = (id, label, data, color) => {
                if(id === 'weight' && weightChart) weightChart.destroy();
                if(id === 'fat' && fatChart) fatChart.destroy();
                const ctx = document.getElementById(id+'Chart').getContext('2d');
                return new Chart(ctx, {
                    type: 'line',
                    data: { labels: dates, datasets: [{ label: label, data: data, borderColor: color, backgroundColor: color, tension: 0.3, pointRadius: 5, pointHoverRadius: 8, spanGaps: true }] },
                    options: { 
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: false, grace: '10%' } },
                        plugins: { datalabels: { align: 'top', font: { weight: 'bold' }, formatter: (value) => value ? value : '' } }
                    },
                    plugins: [ChartDataLabels]
                });
            };
            weightChart = chartConfig('weight', '體重 (kg)', weights, '#475569');
            fatChart = chartConfig('fat', '體脂 (%)', fats, '#f87171');
        }

        function addNewItem() {
            const n = prompt("項目名稱：");
            if(n) {
                const d = prompt("細項 (用 / 分隔)：");
                const c = JSON.parse(localStorage.getItem('customWorkouts')||'{}');
                c[n] = d ? d.split('/') : ["運動"];
                localStorage.setItem('customWorkouts', JSON.stringify(c));
                initWorkoutList([]);
            }
        }

        function deleteItem(t) { if(confirm('刪除？')){ const c=JSON.parse(localStorage.getItem('customWorkouts')||'{}'); delete c[t]; localStorage.setItem('customWorkouts', JSON.stringify(c)); initWorkoutList([]); }}

        window.onload = () => { renderCalendar(); loadDailyData(selectedDateStr); };
    </script>
</body>
</html>